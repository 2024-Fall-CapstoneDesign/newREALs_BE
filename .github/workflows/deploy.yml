on:
  push:
    branches: [master]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    # Java 17 설정
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: 17
        distribution: 'temurin'

    # Gradle Wrapper에 실행 권한 추가
    - name: Grant Execute Permission for Gradlew
      run: chmod +x ./gradlew

    # Gradle로 JAR 파일 빌드
    - name: Build Application
      run: ./gradlew clean build

    # 서버로 JAR 파일 업로드
    - name: Upload JAR to EC2
      uses: appleboy/scp-action@master
      with:
        source: build/libs/newReals_BE.jar
        target: /home/ubuntu/newreals-app/app.jar
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_KEY }}
        port: 22

    # Docker Compose 배포
    - name: Deploy Application
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_KEY }}
        port: 22
        script: |
          cd /home/ubuntu/newreals-app
          docker-compose down || true
          docker-compose up --build -d
          docker ps

