name: Deploy Application

on:
  push:
    branches:
      - master  # 또는 사용하는 브랜치 이름

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: temurin

      - name: Grant execute permission for Gradle Wrapper
        run: chmod +x ./gradlew

      - name: Build the project
        run: ./gradlew build

      - name: Verify build artifacts
        run: ls -l build/libs

      - name: Upload JAR file to the server
        uses: appleboy/scp-action@v0.1.3  # 올바른 버전으로 수정
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ubuntu
          key: ${{ secrets.SERVER_KEY }}
          source: build/libs/*.jar
          target: /home/ubuntu/newreals-app/app.jar

      - name: Add SSH known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy application
        uses: appleboy/ssh-action@v0.1.3  # 올바른 버전으로 수정
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ubuntu
          key: ${{ secrets.SERVER_KEY }}
          script: |
            echo "Deploying application..."
            cd /home/ubuntu/newreals-app
            docker-compose down || true
            docker-compose up -d
